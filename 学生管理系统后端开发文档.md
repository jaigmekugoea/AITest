# å­¦ç”Ÿç®¡ç†ç³»ç»Ÿåç«¯å¼€å‘å®Œæ•´æ–‡æ¡£

## 1. åç«¯é¡¹ç›®æ¦‚è¿°

- .NET 9 - æœ€æ–°çš„.NETå¹³å°ï¼Œæ€§èƒ½å“è¶Š
- ASP.NET Core Web API - è·¨å¹³å°çš„Web APIæ¡†æ¶
- SqlSugar - é«˜æ€§èƒ½.NET ORMæ¡†æ¶ï¼Œæ”¯æŒå¤šæ•°æ®åº“
- SQL Server - ä¼ä¸šçº§å…³ç³»å‹æ•°æ®åº“
- Swagger/OpenAPI - APIæ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ
- Serilog - ç»“æ„åŒ–æ—¥å¿—è®°å½•
- FluentValidation - æµç•…çš„æ•°æ®éªŒè¯

- ğŸš€ é«˜æ€§èƒ½APIè®¾è®¡ï¼Œæ”¯æŒå¤§å¹¶å‘è®¿é—®
- ğŸ—ƒï¸ æ•°æ®åˆ†è¡¨ç­–ç•¥ï¼Œæ”¯æŒæµ·é‡æ•°æ®å­˜å‚¨
- ğŸ”’ å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œå®‰å…¨é˜²æŠ¤
- ğŸ“Š ç»“æ„åŒ–æ—¥å¿—è®°å½•å’Œç›‘æ§
- ğŸ§ª å®Œæ•´çš„å•å…ƒæµ‹è¯•è¦†ç›–
- ğŸ”§ çµæ´»çš„é…ç½®ç®¡ç†
- ğŸ“– è‡ªåŠ¨åŒ–APIæ–‡æ¡£ç”Ÿæˆ


---

## 2. é¡¹ç›®åˆ›å»ºä¸é…ç½®

### 2.1 ç¯å¢ƒå‡†å¤‡

### 2.2 åˆ›å»ºé¡¹ç›®

### 2.3 å®‰è£…NuGetåŒ…

```
# æ£€æŸ¥.NETç‰ˆæœ¬ï¼ˆéœ€è¦9.0+ï¼‰
dotnet --version

# æ£€æŸ¥SQL Serverè¿æ¥
sqlcmd -S localhost -E -Q "SELECT @@VERSION"

# å®‰è£…å¼€å‘å·¥å…·ï¼ˆæ¨èï¼‰
# - Visual Studio 2022 æˆ– VS Code
# - SQL Server Management Studio (SSMS)
# - Postman æˆ– Insomniaï¼ˆAPIæµ‹è¯•ï¼‰
```

```
# åˆ›å»ºè§£å†³æ–¹æ¡ˆ
dotnet new sln -n StudentManagementSystem

# åˆ›å»ºWeb APIé¡¹ç›®
dotnet new webapi -n StudentAPI -f net9.0

# æ·»åŠ é¡¹ç›®åˆ°è§£å†³æ–¹æ¡ˆ
dotnet sln add StudentAPI/StudentAPI.csproj

# è¿›å…¥ä¸»é¡¹ç›®ç›®å½•
cd StudentAPI
```

```
# ORMæ¡†æ¶
dotnet add package SqlSugar --version 5.1.4.156

# æ•°æ®åº“é©±åŠ¨
dotnet add package Microsoft.Data.SqlClient --version 5.1.5

# APIæ–‡æ¡£
dotnet add package Swashbuckle.AspNetCore --version 6.5.0

# æ—¥å¿—æ¡†æ¶
dotnet add package Serilog.AspNetCore --version 7.0.0

# æ•°æ®éªŒè¯
dotnet add package FluentValidation.AspNetCore --version 11.3.0

# ç¼“å­˜
dotnet add package Microsoft.Extensions.Caching.Memory --version 9.0.0
```


---

## 4. ç¨‹åºå…¥å£é…ç½®

#### Program.cs

```
using SqlSugar;
using StudentAPI.Services.Interfaces;
using StudentAPI.Services.Implementations;
using StudentAPI.Middleware;
using FluentValidation.AspNetCore;
using FluentValidation;
using Serilog;

var builder = WebApplication.CreateBuilder(args);

// é…ç½®Serilogæ—¥å¿—
Log.Logger = new LoggerConfiguration()
    .ReadFrom.Configuration(builder.Configuration)
    .CreateLogger();

builder.Host.UseSerilog();

// æ·»åŠ æœåŠ¡åˆ°å®¹å™¨
builder.Services.AddControllers()
    .AddFluentValidation(fv => fv.RegisterValidatorsFromAssemblyContaining());

builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(c =>
{
    c.SwaggerDoc("v1", new() { 
        Title = "å­¦ç”Ÿç®¡ç†ç³»ç»ŸAPI", 
        Version = "v1",
        Description = "å­¦ç”Ÿä¿¡æ¯ç®¡ç†çš„Web APIæ¥å£æ–‡æ¡£",
        Contact = new() 
        {
            Name = "å¼€å‘å›¢é˜Ÿ",
            Email = "dev@example.com"
        }
    });
    
    // åŒ…å«XMLæ³¨é‡Š
    var xmlFile = $"{System.Reflection.Assembly.GetExecutingAssembly().GetName().Name}.xml";
    var xmlPath = Path.Combine(AppContext.BaseDirectory, xmlFile);
    if (File.Exists(xmlPath))
    {
        c.IncludeXmlComments(xmlPath);
    }
});

// é…ç½®SqlSugaræ•°æ®åº“è¿æ¥
builder.Services.AddSingleton(provider =>
{
    var configuration = provider.GetService();
    var connectionString = configuration.GetConnectionString("DefaultConnection");
    
    return new SqlSugarClient(new ConnectionConfig()
    {
        ConnectionString = connectionString,
        DbType = DbType.SqlServer,
        IsAutoCloseConnection = true,
        InitKeyType = InitKeyType.Attribute,
        AopEvents = new AopEvents
        {
            OnLogExecuting = (sql, pars) =>
            {
                if (builder.Environment.IsDevelopment())
                {
                    Console.WriteLine($"æ‰§è¡ŒSQL: {sql}");
                    if (pars != null && pars.Length > 0)
                    {
                        Console.WriteLine($"å‚æ•°: {string.Join(",", pars.Select(p => $"{p.ParameterName}={p.Value}"))}");
                    }
                }
            },
            OnError = (exp) =>
            {
                Console.WriteLine($"SQLæ‰§è¡Œé”™è¯¯: {exp.Sql}");
                Console.WriteLine($"é”™è¯¯ä¿¡æ¯: {exp.Message}");
            }
        }
    });
});

// æ³¨å†Œä¸šåŠ¡æœåŠ¡
builder.Services.AddScoped();
builder.Services.AddScoped();

// é…ç½®å†…å­˜ç¼“å­˜
builder.Services.AddMemoryCache();

// é…ç½®CORSï¼ˆè·¨åŸŸèµ„æºå…±äº«ï¼‰
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowVueApp", policy =>
    {
        policy.WithOrigins("http://localhost:5173", "http://localhost:3000")
              .AllowAnyHeader()
              .AllowAnyMethod()
              .AllowCredentials();
    });
});

// å¥åº·æ£€æŸ¥
builder.Services.AddHealthChecks()
    .AddSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")!);

var app = builder.Build();

// é…ç½®HTTPè¯·æ±‚ç®¡é“
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI(c =>
    {
        c.SwaggerEndpoint("/swagger/v1/swagger.json", "å­¦ç”Ÿç®¡ç†ç³»ç»ŸAPI v1");
        c.RoutePrefix = string.Empty;
    });
}

app.UseHttpsRedirection();

// å¯ç”¨CORS
app.UseCors("AllowVueApp");

// ä½¿ç”¨è‡ªå®šä¹‰ä¸­é—´ä»¶
app.UseMiddleware();
app.UseMiddleware();

app.UseAuthorization();

app.MapControllers();
app.MapHealthChecks("/health");

// å¯åŠ¨æ—¶åˆå§‹åŒ–æ•°æ®åº“è¡¨
using (var scope = app.Services.CreateScope())
{
    var studentService = scope.ServiceProvider.GetRequiredService();
    var logger = scope.ServiceProvider.GetRequiredService>();
    
    try
    {
        var currentYear = DateTime.Now.Year;
        await studentService.EnsureTableExistsAsync(currentYear);
        logger.LogInformation("æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ");
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥");
    }
}

app.Run();
```


---

## 5. æ•°æ®æ¨¡å‹

#### Models/Entities/Student.cs

```
using SqlSugar;
using System.ComponentModel.DataAnnotations;

namespace StudentAPI.Models.Entities
{
    [SugarTable("Students")]
    public class Student
    {
        [SugarColumn(IsPrimaryKey = true, IsIdentity = true)]
        public long Id { get; set; }

        [SugarColumn(Length = 20, IsNullable = false)]
        [SugarIndex(true)]
        public string StudentNo { get; set; } = string.Empty;

        [SugarColumn(Length = 50, IsNullable = false)]
        [SugarIndex]
        public string Name { get; set; } = string.Empty;

        [SugarColumn(Length = 10, IsNullable = false)]
        public string Gender { get; set; } = string.Empty;

        [SugarColumn(IsNullable = true)]
        public DateTime? BirthDate { get; set; }

        [SugarColumn(IsNullable = false)]
        [SugarIndex]
        public int EnrollmentYear { get; set; }

        [SugarColumn(Length = 100, IsNullable = true)]
        [SugarIndex]
        public string? Major { get; set; }

        [SugarColumn(Length = 50, IsNullable = true)]
        public string? Class { get; set; }

        [SugarColumn(Length = 20, IsNullable = true)]
        public string? Phone { get; set; }

        [SugarColumn(Length = 100, IsNullable = true)]
        public string? Email { get; set; }

        [SugarColumn(Length = 500, IsNullable = true)]
        public string? Address { get; set; }

        [SugarColumn(Length = 20, IsNullable = false, DefaultValue = "'åœ¨æ ¡'")]
        public string Status { get; set; } = "åœ¨æ ¡";

        [SugarColumn(IsNullable = false, InsertServerTime = true)]
        public DateTime CreateTime { get; set; }

        [SugarColumn(IsNullable = false, UpdateServerTime = true)]
        public DateTime UpdateTime { get; set; }

        [SugarColumn(IsNullable = false, DefaultValue = "0")]
        public bool IsDeleted { get; set; } = false;
    }
}
```


---

## 6. ä¸šåŠ¡æœåŠ¡å±‚

#### Services/Implementations/StudentService.cs

```
using SqlSugar;
using StudentAPI.Models.DTOs;
using StudentAPI.Models.Entities;
using StudentAPI.Services.Interfaces;
using Microsoft.Extensions.Caching.Memory;

namespace StudentAPI.Services.Implementations
{
    public class StudentService : IStudentService
    {
        private readonly ISqlSugarClient _db;
        private readonly IMemoryCache _cache;
        private readonly ILogger _logger;

        public StudentService(
            ISqlSugarClient db,
            IMemoryCache cache,
            ILogger logger)
        {
            _db = db;
            _cache = cache;
            _logger = logger;
        }

        public async Task> GetStudentsAsync(StudentQueryDto query)
        {
            try
            {
                var tableName = GetTableName(query.EnrollmentYear ?? DateTime.Now.Year);
                
                var queryable = _db.Queryable().AS(tableName);
                
                // æ„å»ºæŸ¥è¯¢æ¡ä»¶
                if (!string.IsNullOrEmpty(query.Keyword))
                {
                    queryable = queryable.Where(s => s.Name.Contains(query.Keyword) || s.StudentNo.Contains(query.Keyword));
                }
                
                if (!string.IsNullOrEmpty(query.Major))
                {
                    queryable = queryable.Where(s => s.Major == query.Major);
                }
                
                if (query.EnrollmentYear.HasValue)
                {
                    queryable = queryable.Where(s => s.EnrollmentYear == query.EnrollmentYear);
                }
                
                if (!string.IsNullOrEmpty(query.Gender))
                {
                    queryable = queryable.Where(s => s.Gender == query.Gender);
                }
                
                if (!string.IsNullOrEmpty(query.Status))
                {
                    queryable = queryable.Where(s => s.Status == query.Status);
                }

                queryable = queryable.Where(s => !s.IsDeleted);

                var total = await queryable.CountAsync();
                
                var students = await queryable
                    .OrderBy(s => s.CreateTime, OrderByType.Desc)
                    .ToPageListAsync(query.PageIndex, query.PageSize);

                var studentDtos = students.Select(MapToDto).ToList();

                return new PagedResultDto
                {
                    Data = studentDtos,
                    Total = total,
                    PageIndex = query.PageIndex,
                    PageSize = query.PageSize
                };
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "æŸ¥è¯¢å­¦ç”Ÿä¿¡æ¯å¤±è´¥");
                throw;
            }
        }

        public async Task GetStudentByIdAsync(long id, int enrollmentYear)
        {
            try
            {
                var tableName = GetTableName(enrollmentYear);
                
                var student = await _db.Queryable()
                    .AS(tableName)
                    .Where(s => s.Id == id && !s.IsDeleted)
                    .FirstAsync();

                return student != null ? MapToDto(student) : null;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "è·å–å­¦ç”Ÿè¯¦æƒ…å¤±è´¥ï¼ŒID: {Id}", id);
                throw;
            }
        }

        public async Task AddStudentAsync(StudentDto studentDto)
        {
            try
            {
                await EnsureTableExistsAsync(studentDto.EnrollmentYear);
                
                var student = MapToEntity(studentDto);
                var tableName = GetTableName(studentDto.EnrollmentYear);

                var result = await _db.Insertable(student)
                    .AS(tableName)
                    .ExecuteCommandAsync();

                return result > 0;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "æ·»åŠ å­¦ç”Ÿå¤±è´¥");
                throw;
            }
        }

        public async Task UpdateStudentAsync(long id, StudentDto studentDto)
        {
            try
            {
                var student = MapToEntity(studentDto);
                student.Id = id;
                
                var tableName = GetTableName(studentDto.EnrollmentYear);

                var result = await _db.Updateable(student)
                    .AS(tableName)
                    .Where(s => s.Id == id && !s.IsDeleted)
                    .ExecuteCommandAsync();

                return result > 0;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "æ›´æ–°å­¦ç”Ÿä¿¡æ¯å¤±è´¥");
                throw;
            }
        }

        public async Task DeleteStudentAsync(long id, int enrollmentYear)
        {
            try
            {
                var tableName = GetTableName(enrollmentYear);

                var result = await _db.Updateable()
                    .AS(tableName)
                    .SetColumns(s => new Student { IsDeleted = true })
                    .Where(s => s.Id == id)
                    .ExecuteCommandAsync();

                return result > 0;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "åˆ é™¤å­¦ç”Ÿå¤±è´¥");
                throw;
            }
        }

        public async Task EnsureTableExistsAsync(int year)
        {
            try
            {
                var tableName = GetTableName(year);
                
                if (!await _db.DbMaintenance.IsAnyTableAsync(tableName))
                {
                    await _db.CodeFirst.SetStringDefaultLength(200).InitTables();
                    _logger.LogInformation("åˆ›å»ºè¡¨: {TableName}", tableName);
                }
                
                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "åˆ›å»ºè¡¨å¤±è´¥");
                throw;
            }
        }

        private string GetTableName(int year)
        {
            return $"Students_{year}";
        }

        private StudentDto MapToDto(Student student)
        {
            return new StudentDto
            {
                Id = student.Id,
                StudentNo = student.StudentNo,
                Name = student.Name,
                Gender = student.Gender,
                BirthDate = student.BirthDate,
                EnrollmentYear = student.EnrollmentYear,
                Major = student.Major,
                Class = student.Class,
                Phone = student.Phone,
                Email = student.Email,
                Address = student.Address,
                Status = student.Status,
                CreateTime = student.CreateTime,
                UpdateTime = student.UpdateTime
            };
        }

        private Student MapToEntity(StudentDto dto)
        {
            return new Student
            {
                StudentNo = dto.StudentNo,
                Name = dto.Name,
                Gender = dto.Gender,
                BirthDate = dto.BirthDate,
                EnrollmentYear = dto.EnrollmentYear,
                Major = dto.Major,
                Class = dto.Class,
                Phone = dto.Phone,
                Email = dto.Email,
                Address = dto.Address,
                Status = dto.Status
            };
        }

        public async Task> GetMajorsAsync()
        {
            var cacheKey = "majors_list";
            if (_cache.TryGetValue(cacheKey, out List? cachedMajors))
            {
                return cachedMajors ?? new List();
            }

            var majors = new List();
            var currentYear = DateTime.Now.Year;
            
            for (int year = currentYear; year >= currentYear - 10; year--)
            {
                var tableName = GetTableName(year);
                
                if (await _db.DbMaintenance.IsAnyTableAsync(tableName))
                {
                    var yearMajors = await _db.Queryable()
                        .AS(tableName)
                        .Where(s => !s.IsDeleted && !string.IsNullOrEmpty(s.Major))
                        .GroupBy(s => s.Major)
                        .Select(s => s.Major)
                        .ToListAsync();
                    
                    majors.AddRange(yearMajors.Where(m => !string.IsNullOrEmpty(m)));
                }
            }

            var uniqueMajors = majors.Distinct().ToList();
            _cache.Set(cacheKey, uniqueMajors, TimeSpan.FromHours(1));
            
            return uniqueMajors;
        }

        public async Task> GetEnrollmentYearsAsync()
        {
            var years = new List();
            var currentYear = DateTime.Now.Year;
            
            for (int year = currentYear; year >= currentYear - 10; year--)
            {
                var tableName = GetTableName(year);
                if (await _db.DbMaintenance.IsAnyTableAsync(tableName))
                {
                    years.Add(year);
                }
            }
            
            return years;
        }
    }
}
```


---

## 7. æ§åˆ¶å™¨å±‚

#### Controllers/StudentsController.cs

```
using Microsoft.AspNetCore.Mvc;
using StudentAPI.Models.DTOs;
using StudentAPI.Services.Interfaces;

namespace StudentAPI.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class StudentsController : ControllerBase
    {
        private readonly IStudentService _studentService;
        private readonly ILogger _logger;

        public StudentsController(
            IStudentService studentService,
            ILogger logger)
        {
            _studentService = studentService;
            _logger = logger;
        }

        /// 
        /// åˆ†é¡µæŸ¥è¯¢å­¦ç”Ÿä¿¡æ¯
        /// 
        [HttpGet]
        public async Task>>> GetStudents([FromQuery] StudentQueryDto query)
        {
            try
            {
                var result = await _studentService.GetStudentsAsync(query);
                return Ok(ApiResult>.Ok(result));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "æŸ¥è¯¢å­¦ç”Ÿä¿¡æ¯å¤±è´¥");
                return StatusCode(500, ApiResult>.Fail("æŸ¥è¯¢å¤±è´¥"));
            }
        }

        /// 
        /// æ ¹æ®IDè·å–å­¦ç”Ÿè¯¦æƒ…
        /// 
        [HttpGet("{id}")]
        public async Task>> GetStudent(long id, [FromQuery] int enrollmentYear)
        {
            try
            {
                var student = await _studentService.GetStudentByIdAsync(id, enrollmentYear);
                if (student == null)
                {
                    return NotFound(ApiResult.Fail("å­¦ç”Ÿä¸å­˜åœ¨"));
                }

                return Ok(ApiResult.Ok(student));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "è·å–å­¦ç”Ÿè¯¦æƒ…å¤±è´¥");
                return StatusCode(500, ApiResult.Fail("è·å–å¤±è´¥"));
            }
        }

        /// 
        /// æ·»åŠ å­¦ç”Ÿ
        /// 
        [HttpPost]
        public async Task>> AddStudent([FromBody] StudentDto studentDto)
        {
            try
            {
                if (!ModelState.IsValid)
                {
                    return BadRequest(ApiResult.Fail("æ•°æ®éªŒè¯å¤±è´¥"));
                }

                var result = await _studentService.AddStudentAsync(studentDto);
                if (result)
                {
                    return Ok(ApiResult.Ok(true, "æ·»åŠ æˆåŠŸ"));
                }

                return BadRequest(ApiResult.Fail("æ·»åŠ å¤±è´¥"));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "æ·»åŠ å­¦ç”Ÿå¤±è´¥");
                return StatusCode(500, ApiResult.Fail("æ·»åŠ å¤±è´¥"));
            }
        }

        /// 
        /// æ›´æ–°å­¦ç”Ÿä¿¡æ¯
        /// 
        [HttpPut("{id}")]
        public async Task>> UpdateStudent(long id, [FromBody] StudentDto studentDto)
        {
            try
            {
                if (!ModelState.IsValid)
                {
                    return BadRequest(ApiResult.Fail("æ•°æ®éªŒè¯å¤±è´¥"));
                }

                var result = await _studentService.UpdateStudentAsync(id, studentDto);
                if (result)
                {
                    return Ok(ApiResult.Ok(true, "æ›´æ–°æˆåŠŸ"));
                }

                return NotFound(ApiResult.Fail("å­¦ç”Ÿä¸å­˜åœ¨"));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "æ›´æ–°å­¦ç”Ÿä¿¡æ¯å¤±è´¥");
                return StatusCode(500, ApiResult.Fail("æ›´æ–°å¤±è´¥"));
            }
        }

        /// 
        /// åˆ é™¤å­¦ç”Ÿ
        /// 
        [HttpDelete("{id}")]
        public async Task>> DeleteStudent(long id, [FromQuery] int enrollmentYear)
        {
            try
            {
                var result = await _studentService.DeleteStudentAsync(id, enrollmentYear);
                if (result)
                {
                    return Ok(ApiResult.Ok(true, "åˆ é™¤æˆåŠŸ"));
                }

                return NotFound(ApiResult.Fail("å­¦ç”Ÿä¸å­˜åœ¨"));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "åˆ é™¤å­¦ç”Ÿå¤±è´¥");
                return StatusCode(500, ApiResult.Fail("åˆ é™¤å¤±è´¥"));
            }
        }

        /// 
        /// è·å–ä¸“ä¸šåˆ—è¡¨
        /// 
        [HttpGet("majors")]
        public async Task>>> GetMajors()
        {
            try
            {
                var majors = await _studentService.GetMajorsAsync();
                return Ok(ApiResult>.Ok(majors));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "è·å–ä¸“ä¸šåˆ—è¡¨å¤±è´¥");
                return StatusCode(500, ApiResult>.Fail("è·å–å¤±è´¥"));
            }
        }

        /// 
        /// è·å–å…¥å­¦å¹´ä»½åˆ—è¡¨
        /// 
        [HttpGet("enrollment-years")]
        public async Task>>> GetEnrollmentYears()
        {
            try
            {
                var years = await _studentService.GetEnrollmentYearsAsync();
                return Ok(ApiResult>.Ok(years));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "è·å–å…¥å­¦å¹´ä»½åˆ—è¡¨å¤±è´¥");
                return StatusCode(500, ApiResult>.Fail("è·å–å¤±è´¥"));
            }
        }
    }
}
```


---

## 8. ä¸­é—´ä»¶

### 11.1 IISéƒ¨ç½²

### 11.2 ç”Ÿäº§ç¯å¢ƒé…ç½®

#### Middleware/ExceptionMiddleware.cs

```
using System.Text.Json;
using StudentAPI.Models.DTOs;

namespace StudentAPI.Middleware
{
    public class ExceptionMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger _logger;

        public ExceptionMiddleware(RequestDelegate next, ILogger logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            try
            {
                await _next(context);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "å‘ç”Ÿæœªå¤„ç†çš„å¼‚å¸¸");
                await HandleExceptionAsync(context, ex);
            }
        }

        private static async Task HandleExceptionAsync(HttpContext context, Exception exception)
        {
            context.Response.ContentType = "application/json";
            
            var response = new ApiResult
            {
                Success = false,
                Message = "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯",
                Data = null
            };

            switch (exception)
            {
                case ArgumentException:
                    context.Response.StatusCode = 400;
                    response.Message = exception.Message;
                    break;
                case UnauthorizedAccessException:
                    context.Response.StatusCode = 401;
                    response.Message = "æœªæˆæƒè®¿é—®";
                    break;
                case KeyNotFoundException:
                    context.Response.StatusCode = 404;
                    response.Message = "èµ„æºæœªæ‰¾åˆ°";
                    break;
                default:
                    context.Response.StatusCode = 500;
                    break;
            }

            var jsonResponse = JsonSerializer.Serialize(response, new JsonSerializerOptions
            {
                PropertyNamingPolicy = JsonNamingPolicy.CamelCase
            });

            await context.Response.WriteAsync(jsonResponse);
        }
    }
}
            

            Middleware/LoggingMiddleware.cs
            
                namespace StudentAPI.Middleware
{
    public class LoggingMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger _logger;

        public LoggingMiddleware(RequestDelegate next, ILogger logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var startTime = DateTime.UtcNow;
            
            _logger.LogInformation("å¼€å§‹å¤„ç†è¯·æ±‚: {Method} {Path}", 
                context.Request.Method, 
                context.Request.Path);

            await _next(context);

            var duration = DateTime.UtcNow - startTime;
            
            _logger.LogInformation("è¯·æ±‚å¤„ç†å®Œæˆ: {Method} {Path} å“åº”: {StatusCode} è€—æ—¶: {Duration}ms",
                context.Request.Method,
                context.Request.Path,
                context.Response.StatusCode,
                duration.TotalMilliseconds);
        }
    }
}
            
        

        
            9. æ•°æ®åº“é…ç½®

            appsettings.json
            
                {
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=StudentManagementDB;Trusted_Connection=true;TrustServerCertificate=true;"
  },
  "Serilog": {
    "MinimumLevel": {
      "Default": "Information",
      "Override": {
        "Microsoft": "Warning",
        "System": "Warning"
      }
    },
    "WriteTo": [
      {
        "Name": "Console"
      },
      {
        "Name": "File",
        "Args": {
          "path": "logs/student-api-.log",
          "rollingInterval": "Day",
          "retainedFileCountLimit": 7
        }
      }
    ]
  },
  "AllowedHosts": "*"
}
            

            appsettings.Development.json
            
                {
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "Microsoft.AspNetCore": "Information"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=StudentManagementDB_Dev;Trusted_Connection=true;TrustServerCertificate=true;"
  }
}
            
        

        
            10. å•å…ƒæµ‹è¯•

            Tests/StudentServiceTests.cs
            
                using Microsoft.Extensions.Caching.Memory;
using Microsoft.Extensions.Logging;
using Moq;
using SqlSugar;
using StudentAPI.Models.DTOs;
using StudentAPI.Models.Entities;
using StudentAPI.Services.Implementations;
using Xunit;

namespace StudentAPI.Tests
{
    public class StudentServiceTests
    {
        private readonly Mock _mockDb;
        private readonly Mock _mockCache;
        private readonly Mock> _mockLogger;
        private readonly StudentService _studentService;

        public StudentServiceTests()
        {
            _mockDb = new Mock();
            _mockCache = new Mock();
            _mockLogger = new Mock>();
            _studentService = new StudentService(_mockDb.Object, _mockCache.Object, _mockLogger.Object);
        }

        [Fact]
        public async Task AddStudentAsync_ShouldReturnTrue_WhenStudentIsValid()
        {
            // Arrange
            var studentDto = new StudentDto
            {
                StudentNo = "2024001",
                Name = "å¼ ä¸‰",
                Gender = "ç”·",
                EnrollmentYear = 2024,
                Major = "è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯"
            };

            _mockDb.Setup(db => db.Insertable(It.IsAny()))
                   .Returns(Mock.Of>());

            // Act & Assert
            await Assert.ThrowsAsync(() => _studentService.AddStudentAsync(studentDto));
        }

        [Theory]
        [InlineData("", "å§“åä¸èƒ½ä¸ºç©º")]
        [InlineData("a", "å§“åé•¿åº¦ä¸èƒ½å°‘äº2ä¸ªå­—ç¬¦")]
        public void ValidateStudent_ShouldReturnFalse_WhenNameIsInvalid(string name, string expectedError)
        {
            // Arrange
            var student = new Student
            {
                StudentNo = "2024001",
                Name = name,
                Gender = "ç”·",
                EnrollmentYear = 2024
            };

            // Act
            var result = student.ValidateStudent();

            // Assert
            Assert.False(result.IsValid);
            Assert.Contains(expectedError, result.ErrorMessages);
        }
    }
}
            
        

        
            11. éƒ¨ç½²é…ç½®

            Dockerfile
            
                # ä½¿ç”¨å®˜æ–¹çš„.NET 9 SDKé•œåƒä½œä¸ºæ„å»ºç¯å¢ƒ
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /app

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY *.csproj ./
RUN dotnet restore

# å¤åˆ¶æ‰€æœ‰æºä»£ç 
COPY . ./
RUN dotnet publish -c Release -o out

# ä½¿ç”¨å®˜æ–¹çš„.NET 9è¿è¡Œæ—¶é•œåƒ
FROM mcr.microsoft.com/dotnet/aspnet:9.0
WORKDIR /app
COPY --from=build /app/out .

# æš´éœ²ç«¯å£
EXPOSE 80
EXPOSE 443

# å¯åŠ¨åº”ç”¨
ENTRYPOINT ["dotnet", "StudentAPI.dll"]
            

            docker-compose.yml
            
                version: '3.8'

services:
  student-api:
    build: .
    ports:
      - "5000:80"
      - "5001:443"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80;https://+:443
    depends_on:
      - sqlserver
    networks:
      - student-network

  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      SA_PASSWORD: "YourPassword123!"
      ACCEPT_EULA: "Y"
    ports:
      - "1433:1433"
    volumes:
      - sqlserver-data:/var/opt/mssql
    networks:
      - student-network

volumes:
  sqlserver-data:

networks:
  student-network:
    driver: bridge
            

            11.1 IISéƒ¨ç½²
            
                # å‘å¸ƒåº”ç”¨
dotnet publish -c Release -o ./publish

# é…ç½®IIS
# 1. åˆ›å»ºåº”ç”¨ç¨‹åºæ± ï¼Œè®¾ç½®.NET CLRç‰ˆæœ¬ä¸º"æ— æ‰˜ç®¡ä»£ç "
# 2. åˆ›å»ºç½‘ç«™ï¼ŒæŒ‡å‘å‘å¸ƒç›®å½•
# 3. ç¡®ä¿åº”ç”¨ç¨‹åºæ± æ ‡è¯†å…·æœ‰å¿…è¦æƒé™

# web.configé…ç½®ç¤ºä¾‹


  
    
      
    
    
  

            

            11.2 ç”Ÿäº§ç¯å¢ƒé…ç½®
            appsettings.Production.json
            
                {
  "Logging": {
    "LogLevel": {
      "Default": "Warning",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=prod-server;Database=StudentManagementDB;User Id=sa;Password=YourProductionPassword;TrustServerCertificate=true;"
  },
  "Serilog": {
    "MinimumLevel": {
      "Default": "Warning"
    },
    "WriteTo": [
      {
        "Name": "File",
        "Args": {
          "path": "/var/log/student-api/student-api-.log",
          "rollingInterval": "Day",
          "retainedFileCountLimit": 30
        }
      }
    ]
  }
}
            
        
    

    
        // å¯¼å‡ºåŠŸèƒ½å®ç°
        function getDocumentContent() {
            const container = document.getElementById('documentContent');
            const clone = container.cloneNode(true);
            const exportButtons = clone.querySelector('.export-buttons');
            if (exportButtons) {
                exportButtons.remove();
            }
            return clone;
        }

        function exportToWord() {
            const btn = document.getElementById('wordBtn');
            btn.disabled = true;
            btn.innerHTML = 'â³ ç”Ÿæˆä¸­...';
            
            try {
                const content = getDocumentContent();
                const wordContent = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' 
                          xmlns:w='urn:schemas-microsoft-com:office:word'
                          xmlns='http://www.w3.org/TR/REC-html40'>
                    <head>
                        <meta charset='utf-8'>
                        <title>å­¦ç”Ÿç®¡ç†ç³»ç»Ÿåç«¯å¼€å‘æ–‡æ¡£</title>
                        <style>
                            body { font-family: 'å¾®è½¯é›…é»‘', Arial, sans-serif; line-height: 1.6; margin: 40px; }
                            h1 { color: #2c3e50; text-align: center; border-bottom: 3px solid #512bd4; padding-bottom: 20px; }
                            h2 { color: #34495e; border-left: 4px solid #512bd4; padding-left: 15px; margin-top: 30px; }
                            h3 { color: #7f8c8d; margin-top: 25px; }
                            .code-block { background: #f8f9fa; border: 1px solid #e9ecef; padding: 15px; border-radius: 5px; font-family: 'Consolas', monospace; }
                            .file-header { background: #512bd4; color: white; padding: 8px 15px; font-weight: bold; }
                            .alert { padding: 15px; border-radius: 5px; margin: 15px 0; }
                            .alert-info { background-color: #d9edf7; border: 1px solid #bce8f1; color: #31708f; }
                            .directory-tree { font-family: monospace; background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; }
                        </style>
                    </head>
                    <body>${content.innerHTML}</body>
                    </html>
                `;
                
                const blob = new Blob(['\ufeff', wordContent], {
                    type: 'application/msword'
                });
                
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'å­¦ç”Ÿç®¡ç†ç³»ç»Ÿåç«¯å¼€å‘æ–‡æ¡£.doc';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = 'ğŸ’¾ å¯¼å‡ºä¸º Word';
                }, 1000);
                
            } catch (error) {
                console.error('å¯¼å‡ºWordå¤±è´¥:', error);
                alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                btn.disabled = false;
                btn.innerHTML = 'ğŸ’¾ å¯¼å‡ºä¸º Word';
            }
        }

        function exportToPDF() {
            const btn = document.getElementById('pdfBtn');
            btn.disabled = true;
            btn.innerHTML = 'â³ ç”Ÿæˆä¸­...';
            
            try {
                const content = getDocumentContent();
                const printWindow = window.open('', '_blank');
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>å­¦ç”Ÿç®¡ç†ç³»ç»Ÿåç«¯å¼€å‘æ–‡æ¡£</title>
                        <style>
                            body { font-family: 'å¾®è½¯é›…é»‘', Arial, sans-serif; line-height: 1.6; margin: 20px; color: #333; }
                            h1 { color: #2c3e50; text-align: center; border-bottom: 3px solid #512bd4; padding-bottom: 20px; page-break-before: avoid; }
                            h2 { color: #34495e; border-left: 4px solid #512bd4; padding-left: 15px; margin-top: 30px; page-break-before: avoid; }
                            h3 { color: #7f8c8d; margin-top: 25px; page-break-before: avoid; }
                            .code-block { background: #f8f9fa; border: 1px solid #e9ecef; padding: 15px; border-radius: 5px; font-family: 'Consolas', monospace; font-size: 12px; page-break-inside: avoid; }
                            .file-header { background: #512bd4; color: white; padding: 8px 15px; font-weight: bold; border-radius: 5px 5px 0 0; }
                            .alert { padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 14px; }
                            .alert-info { background-color: #d9edf7; border: 1px solid #bce8f1; color: #31708f; }
                            .directory-tree { font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 11px; }
                            pre { white-space: pre-wrap; word-wrap: break-word; }
                            @media print {
                                body { margin: 0; }
                                .page-break { page-break-before: always; }
                            }
                        </style>
                    </head>
                    <body>
                        ${content.innerHTML}
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                    
                    btn.disabled = false;
                    btn.innerHTML = 'ğŸ“‹ å¯¼å‡ºä¸º PDF';
                }, 1000);
                
            } catch (error) {
                console.error('å¯¼å‡ºPDFå¤±è´¥:', error);
                alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                btn.disabled = false;
                btn.innerHTML = 'ğŸ“‹ å¯¼å‡ºä¸º PDF';
            }
        }

        function exportToMarkdown() {
            const btn = document.getElementById('mdBtn');
            btn.disabled = true;
            btn.innerHTML = 'â³ ç”Ÿæˆä¸­...';
            
            try {
                const content = getDocumentContent();
                let markdown = '# å­¦ç”Ÿç®¡ç†ç³»ç»Ÿåç«¯å¼€å‘å®Œæ•´æ–‡æ¡£\n\n';
                
                const sections = content.querySelectorAll('section');
                sections.forEach(section => {
                    const h2 = section.querySelector('h2');
                    if (h2) {
                        markdown += `## ${h2.textContent}\n\n`;
                    }
                    
                    const h3Elements = section.querySelectorAll('h3');
                    h3Elements.forEach(h3 => {
                        markdown += `### ${h3.textContent}\n\n`;
                    });
                    
                    const paragraphs = section.querySelectorAll('p');
                    paragraphs.forEach(p => {
                        if (p.textContent.trim()) {
                            markdown += `${p.textContent.trim()}\n\n`;
                        }
                    });
                    
                    const lists = section.querySelectorAll('ul, ol');
                    lists.forEach(list => {
                        const items = list.querySelectorAll('li');
                        items.forEach(item => {
                            markdown += `- ${item.textContent.trim()}\n`;
                        });
                        markdown += '\n';
                    });
                    
                    const codeBlocks = section.querySelectorAll('.code-block');
                    codeBlocks.forEach(code => {
                        const fileHeader = code.previousElementSibling;
                        if (fileHeader && fileHeader.classList.contains('file-header')) {
                            markdown += `#### ${fileHeader.textContent}\n\n`;
                        }
                        markdown += '```\n';
                        markdown += code.textContent.trim();
                        markdown += '\n```\n\n';
                    });
                    
                    markdown += '\n---\n\n';
                });
                
                const blob = new Blob([markdown], {
                    type: 'text/markdown;charset=utf-8'
                });
                
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'å­¦ç”Ÿç®¡ç†ç³»ç»Ÿåç«¯å¼€å‘æ–‡æ¡£.md';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = 'ğŸ“ å¯¼å‡ºä¸º Markdown';
                }, 1000);
                
            } catch (error) {
                console.error('å¯¼å‡ºMarkdownå¤±è´¥:', error);
                alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                btn.disabled = false;
                btn.innerHTML = 'ğŸ“ å¯¼å‡ºä¸º Markdown';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('å­¦ç”Ÿç®¡ç†ç³»ç»Ÿåç«¯å¼€å‘æ–‡æ¡£å·²åŠ è½½');
            
            // æ·»åŠ å¹³æ»‘æ»šåŠ¨æ•ˆæœ
            document.querySelectorAll('.toc a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
        });
```

#### Middleware/LoggingMiddleware.cs

```
namespace StudentAPI.Middleware
{
    public class LoggingMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger _logger;

        public LoggingMiddleware(RequestDelegate next, ILogger logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var startTime = DateTime.UtcNow;
            
            _logger.LogInformation("å¼€å§‹å¤„ç†è¯·æ±‚: {Method} {Path}", 
                context.Request.Method, 
                context.Request.Path);

            await _next(context);

            var duration = DateTime.UtcNow - startTime;
            
            _logger.LogInformation("è¯·æ±‚å¤„ç†å®Œæˆ: {Method} {Path} å“åº”: {StatusCode} è€—æ—¶: {Duration}ms",
                context.Request.Method,
                context.Request.Path,
                context.Response.StatusCode,
                duration.TotalMilliseconds);
        }
    }
}
```

#### appsettings.json

```
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=StudentManagementDB;Trusted_Connection=true;TrustServerCertificate=true;"
  },
  "Serilog": {
    "MinimumLevel": {
      "Default": "Information",
      "Override": {
        "Microsoft": "Warning",
        "System": "Warning"
      }
    },
    "WriteTo": [
      {
        "Name": "Console"
      },
      {
        "Name": "File",
        "Args": {
          "path": "logs/student-api-.log",
          "rollingInterval": "Day",
          "retainedFileCountLimit": 7
        }
      }
    ]
  },
  "AllowedHosts": "*"
}
```

#### appsettings.Development.json

```
{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "Microsoft.AspNetCore": "Information"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=StudentManagementDB_Dev;Trusted_Connection=true;TrustServerCertificate=true;"
  }
}
```

#### Tests/StudentServiceTests.cs

```
using Microsoft.Extensions.Caching.Memory;
using Microsoft.Extensions.Logging;
using Moq;
using SqlSugar;
using StudentAPI.Models.DTOs;
using StudentAPI.Models.Entities;
using StudentAPI.Services.Implementations;
using Xunit;

namespace StudentAPI.Tests
{
    public class StudentServiceTests
    {
        private readonly Mock _mockDb;
        private readonly Mock _mockCache;
        private readonly Mock> _mockLogger;
        private readonly StudentService _studentService;

        public StudentServiceTests()
        {
            _mockDb = new Mock();
            _mockCache = new Mock();
            _mockLogger = new Mock>();
            _studentService = new StudentService(_mockDb.Object, _mockCache.Object, _mockLogger.Object);
        }

        [Fact]
        public async Task AddStudentAsync_ShouldReturnTrue_WhenStudentIsValid()
        {
            // Arrange
            var studentDto = new StudentDto
            {
                StudentNo = "2024001",
                Name = "å¼ ä¸‰",
                Gender = "ç”·",
                EnrollmentYear = 2024,
                Major = "è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯"
            };

            _mockDb.Setup(db => db.Insertable(It.IsAny()))
                   .Returns(Mock.Of>());

            // Act & Assert
            await Assert.ThrowsAsync(() => _studentService.AddStudentAsync(studentDto));
        }

        [Theory]
        [InlineData("", "å§“åä¸èƒ½ä¸ºç©º")]
        [InlineData("a", "å§“åé•¿åº¦ä¸èƒ½å°‘äº2ä¸ªå­—ç¬¦")]
        public void ValidateStudent_ShouldReturnFalse_WhenNameIsInvalid(string name, string expectedError)
        {
            // Arrange
            var student = new Student
            {
                StudentNo = "2024001",
                Name = name,
                Gender = "ç”·",
                EnrollmentYear = 2024
            };

            // Act
            var result = student.ValidateStudent();

            // Assert
            Assert.False(result.IsValid);
            Assert.Contains(expectedError, result.ErrorMessages);
        }
    }
}
```

#### Dockerfile

```
# ä½¿ç”¨å®˜æ–¹çš„.NET 9 SDKé•œåƒä½œä¸ºæ„å»ºç¯å¢ƒ
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /app

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY *.csproj ./
RUN dotnet restore

# å¤åˆ¶æ‰€æœ‰æºä»£ç 
COPY . ./
RUN dotnet publish -c Release -o out

# ä½¿ç”¨å®˜æ–¹çš„.NET 9è¿è¡Œæ—¶é•œåƒ
FROM mcr.microsoft.com/dotnet/aspnet:9.0
WORKDIR /app
COPY --from=build /app/out .

# æš´éœ²ç«¯å£
EXPOSE 80
EXPOSE 443

# å¯åŠ¨åº”ç”¨
ENTRYPOINT ["dotnet", "StudentAPI.dll"]
```

#### docker-compose.yml

```
version: '3.8'

services:
  student-api:
    build: .
    ports:
      - "5000:80"
      - "5001:443"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80;https://+:443
    depends_on:
      - sqlserver
    networks:
      - student-network

  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      SA_PASSWORD: "YourPassword123!"
      ACCEPT_EULA: "Y"
    ports:
      - "1433:1433"
    volumes:
      - sqlserver-data:/var/opt/mssql
    networks:
      - student-network

volumes:
  sqlserver-data:

networks:
  student-network:
    driver: bridge
```

```
# å‘å¸ƒåº”ç”¨
dotnet publish -c Release -o ./publish

# é…ç½®IIS
# 1. åˆ›å»ºåº”ç”¨ç¨‹åºæ± ï¼Œè®¾ç½®.NET CLRç‰ˆæœ¬ä¸º"æ— æ‰˜ç®¡ä»£ç "
# 2. åˆ›å»ºç½‘ç«™ï¼ŒæŒ‡å‘å‘å¸ƒç›®å½•
# 3. ç¡®ä¿åº”ç”¨ç¨‹åºæ± æ ‡è¯†å…·æœ‰å¿…è¦æƒé™

# web.configé…ç½®ç¤ºä¾‹
```

#### appsettings.Production.json

```
{
  "Logging": {
    "LogLevel": {
      "Default": "Warning",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=prod-server;Database=StudentManagementDB;User Id=sa;Password=YourProductionPassword;TrustServerCertificate=true;"
  },
  "Serilog": {
    "MinimumLevel": {
      "Default": "Warning"
    },
    "WriteTo": [
      {
        "Name": "File",
        "Args": {
          "path": "/var/log/student-api/student-api-.log",
          "rollingInterval": "Day",
          "retainedFileCountLimit": 30
        }
      }
    ]
  }
}
```


---

## 9. æ•°æ®åº“é…ç½®

#### appsettings.json

```
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=StudentManagementDB;Trusted_Connection=true;TrustServerCertificate=true;"
  },
  "Serilog": {
    "MinimumLevel": {
      "Default": "Information",
      "Override": {
        "Microsoft": "Warning",
        "System": "Warning"
      }
    },
    "WriteTo": [
      {
        "Name": "Console"
      },
      {
        "Name": "File",
        "Args": {
          "path": "logs/student-api-.log",
          "rollingInterval": "Day",
          "retainedFileCountLimit": 7
        }
      }
    ]
  },
  "AllowedHosts": "*"
}
```

#### appsettings.Development.json

```
{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "Microsoft.AspNetCore": "Information"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=StudentManagementDB_Dev;Trusted_Connection=true;TrustServerCertificate=true;"
  }
}
```


---

## 10. å•å…ƒæµ‹è¯•

#### Tests/StudentServiceTests.cs

```
using Microsoft.Extensions.Caching.Memory;
using Microsoft.Extensions.Logging;
using Moq;
using SqlSugar;
using StudentAPI.Models.DTOs;
using StudentAPI.Models.Entities;
using StudentAPI.Services.Implementations;
using Xunit;

namespace StudentAPI.Tests
{
    public class StudentServiceTests
    {
        private readonly Mock _mockDb;
        private readonly Mock _mockCache;
        private readonly Mock> _mockLogger;
        private readonly StudentService _studentService;

        public StudentServiceTests()
        {
            _mockDb = new Mock();
            _mockCache = new Mock();
            _mockLogger = new Mock>();
            _studentService = new StudentService(_mockDb.Object, _mockCache.Object, _mockLogger.Object);
        }

        [Fact]
        public async Task AddStudentAsync_ShouldReturnTrue_WhenStudentIsValid()
        {
            // Arrange
            var studentDto = new StudentDto
            {
                StudentNo = "2024001",
                Name = "å¼ ä¸‰",
                Gender = "ç”·",
                EnrollmentYear = 2024,
                Major = "è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯"
            };

            _mockDb.Setup(db => db.Insertable(It.IsAny()))
                   .Returns(Mock.Of>());

            // Act & Assert
            await Assert.ThrowsAsync(() => _studentService.AddStudentAsync(studentDto));
        }

        [Theory]
        [InlineData("", "å§“åä¸èƒ½ä¸ºç©º")]
        [InlineData("a", "å§“åé•¿åº¦ä¸èƒ½å°‘äº2ä¸ªå­—ç¬¦")]
        public void ValidateStudent_ShouldReturnFalse_WhenNameIsInvalid(string name, string expectedError)
        {
            // Arrange
            var student = new Student
            {
                StudentNo = "2024001",
                Name = name,
                Gender = "ç”·",
                EnrollmentYear = 2024
            };

            // Act
            var result = student.ValidateStudent();

            // Assert
            Assert.False(result.IsValid);
            Assert.Contains(expectedError, result.ErrorMessages);
        }
    }
}
```


---

## 11. éƒ¨ç½²é…ç½®

### 11.1 IISéƒ¨ç½²

### 11.2 ç”Ÿäº§ç¯å¢ƒé…ç½®

#### Dockerfile

```
# ä½¿ç”¨å®˜æ–¹çš„.NET 9 SDKé•œåƒä½œä¸ºæ„å»ºç¯å¢ƒ
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /app

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY *.csproj ./
RUN dotnet restore

# å¤åˆ¶æ‰€æœ‰æºä»£ç 
COPY . ./
RUN dotnet publish -c Release -o out

# ä½¿ç”¨å®˜æ–¹çš„.NET 9è¿è¡Œæ—¶é•œåƒ
FROM mcr.microsoft.com/dotnet/aspnet:9.0
WORKDIR /app
COPY --from=build /app/out .

# æš´éœ²ç«¯å£
EXPOSE 80
EXPOSE 443

# å¯åŠ¨åº”ç”¨
ENTRYPOINT ["dotnet", "StudentAPI.dll"]
```

#### docker-compose.yml

```
version: '3.8'

services:
  student-api:
    build: .
    ports:
      - "5000:80"
      - "5001:443"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80;https://+:443
    depends_on:
      - sqlserver
    networks:
      - student-network

  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      SA_PASSWORD: "YourPassword123!"
      ACCEPT_EULA: "Y"
    ports:
      - "1433:1433"
    volumes:
      - sqlserver-data:/var/opt/mssql
    networks:
      - student-network

volumes:
  sqlserver-data:

networks:
  student-network:
    driver: bridge
```

```
# å‘å¸ƒåº”ç”¨
dotnet publish -c Release -o ./publish

# é…ç½®IIS
# 1. åˆ›å»ºåº”ç”¨ç¨‹åºæ± ï¼Œè®¾ç½®.NET CLRç‰ˆæœ¬ä¸º"æ— æ‰˜ç®¡ä»£ç "
# 2. åˆ›å»ºç½‘ç«™ï¼ŒæŒ‡å‘å‘å¸ƒç›®å½•
# 3. ç¡®ä¿åº”ç”¨ç¨‹åºæ± æ ‡è¯†å…·æœ‰å¿…è¦æƒé™

# web.configé…ç½®ç¤ºä¾‹
```

#### appsettings.Production.json

```
{
  "Logging": {
    "LogLevel": {
      "Default": "Warning",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=prod-server;Database=StudentManagementDB;User Id=sa;Password=YourProductionPassword;TrustServerCertificate=true;"
  },
  "Serilog": {
    "MinimumLevel": {
      "Default": "Warning"
    },
    "WriteTo": [
      {
        "Name": "File",
        "Args": {
          "path": "/var/log/student-api/student-api-.log",
          "rollingInterval": "Day",
          "retainedFileCountLimit": 30
        }
      }
    ]
  }
}
```


---

