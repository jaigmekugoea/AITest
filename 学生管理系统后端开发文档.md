# 学生管理系统后端开发完整文档

## 1. 后端项目概述

- .NET 9 - 最新的.NET平台，性能卓越
- ASP.NET Core Web API - 跨平台的Web API框架
- SqlSugar - 高性能.NET ORM框架，支持多数据库
- SQL Server - 企业级关系型数据库
- Swagger/OpenAPI - API文档自动生成
- Serilog - 结构化日志记录
- FluentValidation - 流畅的数据验证

- 🚀 高性能API设计，支持大并发访问
- 🗃️ 数据分表策略，支持海量数据存储
- 🔒 完善的异常处理和安全防护
- 📊 结构化日志记录和监控
- 🧪 完整的单元测试覆盖
- 🔧 灵活的配置管理
- 📖 自动化API文档生成


---

## 2. 项目创建与配置

### 2.1 环境准备

### 2.2 创建项目

### 2.3 安装NuGet包

```
# 检查.NET版本（需要9.0+）
dotnet --version

# 检查SQL Server连接
sqlcmd -S localhost -E -Q "SELECT @@VERSION"

# 安装开发工具（推荐）
# - Visual Studio 2022 或 VS Code
# - SQL Server Management Studio (SSMS)
# - Postman 或 Insomnia（API测试）
```

```
# 创建解决方案
dotnet new sln -n StudentManagementSystem

# 创建Web API项目
dotnet new webapi -n StudentAPI -f net9.0

# 添加项目到解决方案
dotnet sln add StudentAPI/StudentAPI.csproj

# 进入主项目目录
cd StudentAPI
```

```
# ORM框架
dotnet add package SqlSugar --version 5.1.4.156

# 数据库驱动
dotnet add package Microsoft.Data.SqlClient --version 5.1.5

# API文档
dotnet add package Swashbuckle.AspNetCore --version 6.5.0

# 日志框架
dotnet add package Serilog.AspNetCore --version 7.0.0

# 数据验证
dotnet add package FluentValidation.AspNetCore --version 11.3.0

# 缓存
dotnet add package Microsoft.Extensions.Caching.Memory --version 9.0.0
```


---

## 4. 程序入口配置

#### Program.cs

```
using SqlSugar;
using StudentAPI.Services.Interfaces;
using StudentAPI.Services.Implementations;
using StudentAPI.Middleware;
using FluentValidation.AspNetCore;
using FluentValidation;
using Serilog;

var builder = WebApplication.CreateBuilder(args);

// 配置Serilog日志
Log.Logger = new LoggerConfiguration()
    .ReadFrom.Configuration(builder.Configuration)
    .CreateLogger();

builder.Host.UseSerilog();

// 添加服务到容器
builder.Services.AddControllers()
    .AddFluentValidation(fv => fv.RegisterValidatorsFromAssemblyContaining());

builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(c =>
{
    c.SwaggerDoc("v1", new() { 
        Title = "学生管理系统API", 
        Version = "v1",
        Description = "学生信息管理的Web API接口文档",
        Contact = new() 
        {
            Name = "开发团队",
            Email = "dev@example.com"
        }
    });
    
    // 包含XML注释
    var xmlFile = $"{System.Reflection.Assembly.GetExecutingAssembly().GetName().Name}.xml";
    var xmlPath = Path.Combine(AppContext.BaseDirectory, xmlFile);
    if (File.Exists(xmlPath))
    {
        c.IncludeXmlComments(xmlPath);
    }
});

// 配置SqlSugar数据库连接
builder.Services.AddSingleton(provider =>
{
    var configuration = provider.GetService();
    var connectionString = configuration.GetConnectionString("DefaultConnection");
    
    return new SqlSugarClient(new ConnectionConfig()
    {
        ConnectionString = connectionString,
        DbType = DbType.SqlServer,
        IsAutoCloseConnection = true,
        InitKeyType = InitKeyType.Attribute,
        AopEvents = new AopEvents
        {
            OnLogExecuting = (sql, pars) =>
            {
                if (builder.Environment.IsDevelopment())
                {
                    Console.WriteLine($"执行SQL: {sql}");
                    if (pars != null && pars.Length > 0)
                    {
                        Console.WriteLine($"参数: {string.Join(",", pars.Select(p => $"{p.ParameterName}={p.Value}"))}");
                    }
                }
            },
            OnError = (exp) =>
            {
                Console.WriteLine($"SQL执行错误: {exp.Sql}");
                Console.WriteLine($"错误信息: {exp.Message}");
            }
        }
    });
});

// 注册业务服务
builder.Services.AddScoped();
builder.Services.AddScoped();

// 配置内存缓存
builder.Services.AddMemoryCache();

// 配置CORS（跨域资源共享）
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowVueApp", policy =>
    {
        policy.WithOrigins("http://localhost:5173", "http://localhost:3000")
              .AllowAnyHeader()
              .AllowAnyMethod()
              .AllowCredentials();
    });
});

// 健康检查
builder.Services.AddHealthChecks()
    .AddSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")!);

var app = builder.Build();

// 配置HTTP请求管道
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI(c =>
    {
        c.SwaggerEndpoint("/swagger/v1/swagger.json", "学生管理系统API v1");
        c.RoutePrefix = string.Empty;
    });
}

app.UseHttpsRedirection();

// 启用CORS
app.UseCors("AllowVueApp");

// 使用自定义中间件
app.UseMiddleware();
app.UseMiddleware();

app.UseAuthorization();

app.MapControllers();
app.MapHealthChecks("/health");

// 启动时初始化数据库表
using (var scope = app.Services.CreateScope())
{
    var studentService = scope.ServiceProvider.GetRequiredService();
    var logger = scope.ServiceProvider.GetRequiredService>();
    
    try
    {
        var currentYear = DateTime.Now.Year;
        await studentService.EnsureTableExistsAsync(currentYear);
        logger.LogInformation("数据库初始化完成");
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "数据库初始化失败");
    }
}

app.Run();
```


---

## 5. 数据模型

#### Models/Entities/Student.cs

```
using SqlSugar;
using System.ComponentModel.DataAnnotations;

namespace StudentAPI.Models.Entities
{
    [SugarTable("Students")]
    public class Student
    {
        [SugarColumn(IsPrimaryKey = true, IsIdentity = true)]
        public long Id { get; set; }

        [SugarColumn(Length = 20, IsNullable = false)]
        [SugarIndex(true)]
        public string StudentNo { get; set; } = string.Empty;

        [SugarColumn(Length = 50, IsNullable = false)]
        [SugarIndex]
        public string Name { get; set; } = string.Empty;

        [SugarColumn(Length = 10, IsNullable = false)]
        public string Gender { get; set; } = string.Empty;

        [SugarColumn(IsNullable = true)]
        public DateTime? BirthDate { get; set; }

        [SugarColumn(IsNullable = false)]
        [SugarIndex]
        public int EnrollmentYear { get; set; }

        [SugarColumn(Length = 100, IsNullable = true)]
        [SugarIndex]
        public string? Major { get; set; }

        [SugarColumn(Length = 50, IsNullable = true)]
        public string? Class { get; set; }

        [SugarColumn(Length = 20, IsNullable = true)]
        public string? Phone { get; set; }

        [SugarColumn(Length = 100, IsNullable = true)]
        public string? Email { get; set; }

        [SugarColumn(Length = 500, IsNullable = true)]
        public string? Address { get; set; }

        [SugarColumn(Length = 20, IsNullable = false, DefaultValue = "'在校'")]
        public string Status { get; set; } = "在校";

        [SugarColumn(IsNullable = false, InsertServerTime = true)]
        public DateTime CreateTime { get; set; }

        [SugarColumn(IsNullable = false, UpdateServerTime = true)]
        public DateTime UpdateTime { get; set; }

        [SugarColumn(IsNullable = false, DefaultValue = "0")]
        public bool IsDeleted { get; set; } = false;
    }
}
```


---

## 6. 业务服务层

#### Services/Implementations/StudentService.cs

```
using SqlSugar;
using StudentAPI.Models.DTOs;
using StudentAPI.Models.Entities;
using StudentAPI.Services.Interfaces;
using Microsoft.Extensions.Caching.Memory;

namespace StudentAPI.Services.Implementations
{
    public class StudentService : IStudentService
    {
        private readonly ISqlSugarClient _db;
        private readonly IMemoryCache _cache;
        private readonly ILogger _logger;

        public StudentService(
            ISqlSugarClient db,
            IMemoryCache cache,
            ILogger logger)
        {
            _db = db;
            _cache = cache;
            _logger = logger;
        }

        public async Task> GetStudentsAsync(StudentQueryDto query)
        {
            try
            {
                var tableName = GetTableName(query.EnrollmentYear ?? DateTime.Now.Year);
                
                var queryable = _db.Queryable().AS(tableName);
                
                // 构建查询条件
                if (!string.IsNullOrEmpty(query.Keyword))
                {
                    queryable = queryable.Where(s => s.Name.Contains(query.Keyword) || s.StudentNo.Contains(query.Keyword));
                }
                
                if (!string.IsNullOrEmpty(query.Major))
                {
                    queryable = queryable.Where(s => s.Major == query.Major);
                }
                
                if (query.EnrollmentYear.HasValue)
                {
                    queryable = queryable.Where(s => s.EnrollmentYear == query.EnrollmentYear);
                }
                
                if (!string.IsNullOrEmpty(query.Gender))
                {
                    queryable = queryable.Where(s => s.Gender == query.Gender);
                }
                
                if (!string.IsNullOrEmpty(query.Status))
                {
                    queryable = queryable.Where(s => s.Status == query.Status);
                }

                queryable = queryable.Where(s => !s.IsDeleted);

                var total = await queryable.CountAsync();
                
                var students = await queryable
                    .OrderBy(s => s.CreateTime, OrderByType.Desc)
                    .ToPageListAsync(query.PageIndex, query.PageSize);

                var studentDtos = students.Select(MapToDto).ToList();

                return new PagedResultDto
                {
                    Data = studentDtos,
                    Total = total,
                    PageIndex = query.PageIndex,
                    PageSize = query.PageSize
                };
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "查询学生信息失败");
                throw;
            }
        }

        public async Task GetStudentByIdAsync(long id, int enrollmentYear)
        {
            try
            {
                var tableName = GetTableName(enrollmentYear);
                
                var student = await _db.Queryable()
                    .AS(tableName)
                    .Where(s => s.Id == id && !s.IsDeleted)
                    .FirstAsync();

                return student != null ? MapToDto(student) : null;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "获取学生详情失败，ID: {Id}", id);
                throw;
            }
        }

        public async Task AddStudentAsync(StudentDto studentDto)
        {
            try
            {
                await EnsureTableExistsAsync(studentDto.EnrollmentYear);
                
                var student = MapToEntity(studentDto);
                var tableName = GetTableName(studentDto.EnrollmentYear);

                var result = await _db.Insertable(student)
                    .AS(tableName)
                    .ExecuteCommandAsync();

                return result > 0;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "添加学生失败");
                throw;
            }
        }

        public async Task UpdateStudentAsync(long id, StudentDto studentDto)
        {
            try
            {
                var student = MapToEntity(studentDto);
                student.Id = id;
                
                var tableName = GetTableName(studentDto.EnrollmentYear);

                var result = await _db.Updateable(student)
                    .AS(tableName)
                    .Where(s => s.Id == id && !s.IsDeleted)
                    .ExecuteCommandAsync();

                return result > 0;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "更新学生信息失败");
                throw;
            }
        }

        public async Task DeleteStudentAsync(long id, int enrollmentYear)
        {
            try
            {
                var tableName = GetTableName(enrollmentYear);

                var result = await _db.Updateable()
                    .AS(tableName)
                    .SetColumns(s => new Student { IsDeleted = true })
                    .Where(s => s.Id == id)
                    .ExecuteCommandAsync();

                return result > 0;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "删除学生失败");
                throw;
            }
        }

        public async Task EnsureTableExistsAsync(int year)
        {
            try
            {
                var tableName = GetTableName(year);
                
                if (!await _db.DbMaintenance.IsAnyTableAsync(tableName))
                {
                    await _db.CodeFirst.SetStringDefaultLength(200).InitTables();
                    _logger.LogInformation("创建表: {TableName}", tableName);
                }
                
                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "创建表失败");
                throw;
            }
        }

        private string GetTableName(int year)
        {
            return $"Students_{year}";
        }

        private StudentDto MapToDto(Student student)
        {
            return new StudentDto
            {
                Id = student.Id,
                StudentNo = student.StudentNo,
                Name = student.Name,
                Gender = student.Gender,
                BirthDate = student.BirthDate,
                EnrollmentYear = student.EnrollmentYear,
                Major = student.Major,
                Class = student.Class,
                Phone = student.Phone,
                Email = student.Email,
                Address = student.Address,
                Status = student.Status,
                CreateTime = student.CreateTime,
                UpdateTime = student.UpdateTime
            };
        }

        private Student MapToEntity(StudentDto dto)
        {
            return new Student
            {
                StudentNo = dto.StudentNo,
                Name = dto.Name,
                Gender = dto.Gender,
                BirthDate = dto.BirthDate,
                EnrollmentYear = dto.EnrollmentYear,
                Major = dto.Major,
                Class = dto.Class,
                Phone = dto.Phone,
                Email = dto.Email,
                Address = dto.Address,
                Status = dto.Status
            };
        }

        public async Task> GetMajorsAsync()
        {
            var cacheKey = "majors_list";
            if (_cache.TryGetValue(cacheKey, out List? cachedMajors))
            {
                return cachedMajors ?? new List();
            }

            var majors = new List();
            var currentYear = DateTime.Now.Year;
            
            for (int year = currentYear; year >= currentYear - 10; year--)
            {
                var tableName = GetTableName(year);
                
                if (await _db.DbMaintenance.IsAnyTableAsync(tableName))
                {
                    var yearMajors = await _db.Queryable()
                        .AS(tableName)
                        .Where(s => !s.IsDeleted && !string.IsNullOrEmpty(s.Major))
                        .GroupBy(s => s.Major)
                        .Select(s => s.Major)
                        .ToListAsync();
                    
                    majors.AddRange(yearMajors.Where(m => !string.IsNullOrEmpty(m)));
                }
            }

            var uniqueMajors = majors.Distinct().ToList();
            _cache.Set(cacheKey, uniqueMajors, TimeSpan.FromHours(1));
            
            return uniqueMajors;
        }

        public async Task> GetEnrollmentYearsAsync()
        {
            var years = new List();
            var currentYear = DateTime.Now.Year;
            
            for (int year = currentYear; year >= currentYear - 10; year--)
            {
                var tableName = GetTableName(year);
                if (await _db.DbMaintenance.IsAnyTableAsync(tableName))
                {
                    years.Add(year);
                }
            }
            
            return years;
        }
    }
}
```


---

## 7. 控制器层

#### Controllers/StudentsController.cs

```
using Microsoft.AspNetCore.Mvc;
using StudentAPI.Models.DTOs;
using StudentAPI.Services.Interfaces;

namespace StudentAPI.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class StudentsController : ControllerBase
    {
        private readonly IStudentService _studentService;
        private readonly ILogger _logger;

        public StudentsController(
            IStudentService studentService,
            ILogger logger)
        {
            _studentService = studentService;
            _logger = logger;
        }

        /// 
        /// 分页查询学生信息
        /// 
        [HttpGet]
        public async Task>>> GetStudents([FromQuery] StudentQueryDto query)
        {
            try
            {
                var result = await _studentService.GetStudentsAsync(query);
                return Ok(ApiResult>.Ok(result));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "查询学生信息失败");
                return StatusCode(500, ApiResult>.Fail("查询失败"));
            }
        }

        /// 
        /// 根据ID获取学生详情
        /// 
        [HttpGet("{id}")]
        public async Task>> GetStudent(long id, [FromQuery] int enrollmentYear)
        {
            try
            {
                var student = await _studentService.GetStudentByIdAsync(id, enrollmentYear);
                if (student == null)
                {
                    return NotFound(ApiResult.Fail("学生不存在"));
                }

                return Ok(ApiResult.Ok(student));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "获取学生详情失败");
                return StatusCode(500, ApiResult.Fail("获取失败"));
            }
        }

        /// 
        /// 添加学生
        /// 
        [HttpPost]
        public async Task>> AddStudent([FromBody] StudentDto studentDto)
        {
            try
            {
                if (!ModelState.IsValid)
                {
                    return BadRequest(ApiResult.Fail("数据验证失败"));
                }

                var result = await _studentService.AddStudentAsync(studentDto);
                if (result)
                {
                    return Ok(ApiResult.Ok(true, "添加成功"));
                }

                return BadRequest(ApiResult.Fail("添加失败"));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "添加学生失败");
                return StatusCode(500, ApiResult.Fail("添加失败"));
            }
        }

        /// 
        /// 更新学生信息
        /// 
        [HttpPut("{id}")]
        public async Task>> UpdateStudent(long id, [FromBody] StudentDto studentDto)
        {
            try
            {
                if (!ModelState.IsValid)
                {
                    return BadRequest(ApiResult.Fail("数据验证失败"));
                }

                var result = await _studentService.UpdateStudentAsync(id, studentDto);
                if (result)
                {
                    return Ok(ApiResult.Ok(true, "更新成功"));
                }

                return NotFound(ApiResult.Fail("学生不存在"));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "更新学生信息失败");
                return StatusCode(500, ApiResult.Fail("更新失败"));
            }
        }

        /// 
        /// 删除学生
        /// 
        [HttpDelete("{id}")]
        public async Task>> DeleteStudent(long id, [FromQuery] int enrollmentYear)
        {
            try
            {
                var result = await _studentService.DeleteStudentAsync(id, enrollmentYear);
                if (result)
                {
                    return Ok(ApiResult.Ok(true, "删除成功"));
                }

                return NotFound(ApiResult.Fail("学生不存在"));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "删除学生失败");
                return StatusCode(500, ApiResult.Fail("删除失败"));
            }
        }

        /// 
        /// 获取专业列表
        /// 
        [HttpGet("majors")]
        public async Task>>> GetMajors()
        {
            try
            {
                var majors = await _studentService.GetMajorsAsync();
                return Ok(ApiResult>.Ok(majors));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "获取专业列表失败");
                return StatusCode(500, ApiResult>.Fail("获取失败"));
            }
        }

        /// 
        /// 获取入学年份列表
        /// 
        [HttpGet("enrollment-years")]
        public async Task>>> GetEnrollmentYears()
        {
            try
            {
                var years = await _studentService.GetEnrollmentYearsAsync();
                return Ok(ApiResult>.Ok(years));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "获取入学年份列表失败");
                return StatusCode(500, ApiResult>.Fail("获取失败"));
            }
        }
    }
}
```


---

## 8. 中间件

### 11.1 IIS部署

### 11.2 生产环境配置

#### Middleware/ExceptionMiddleware.cs

```
using System.Text.Json;
using StudentAPI.Models.DTOs;

namespace StudentAPI.Middleware
{
    public class ExceptionMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger _logger;

        public ExceptionMiddleware(RequestDelegate next, ILogger logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            try
            {
                await _next(context);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "发生未处理的异常");
                await HandleExceptionAsync(context, ex);
            }
        }

        private static async Task HandleExceptionAsync(HttpContext context, Exception exception)
        {
            context.Response.ContentType = "application/json";
            
            var response = new ApiResult
            {
                Success = false,
                Message = "服务器内部错误",
                Data = null
            };

            switch (exception)
            {
                case ArgumentException:
                    context.Response.StatusCode = 400;
                    response.Message = exception.Message;
                    break;
                case UnauthorizedAccessException:
                    context.Response.StatusCode = 401;
                    response.Message = "未授权访问";
                    break;
                case KeyNotFoundException:
                    context.Response.StatusCode = 404;
                    response.Message = "资源未找到";
                    break;
                default:
                    context.Response.StatusCode = 500;
                    break;
            }

            var jsonResponse = JsonSerializer.Serialize(response, new JsonSerializerOptions
            {
                PropertyNamingPolicy = JsonNamingPolicy.CamelCase
            });

            await context.Response.WriteAsync(jsonResponse);
        }
    }
}
            

            Middleware/LoggingMiddleware.cs
            
                namespace StudentAPI.Middleware
{
    public class LoggingMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger _logger;

        public LoggingMiddleware(RequestDelegate next, ILogger logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var startTime = DateTime.UtcNow;
            
            _logger.LogInformation("开始处理请求: {Method} {Path}", 
                context.Request.Method, 
                context.Request.Path);

            await _next(context);

            var duration = DateTime.UtcNow - startTime;
            
            _logger.LogInformation("请求处理完成: {Method} {Path} 响应: {StatusCode} 耗时: {Duration}ms",
                context.Request.Method,
                context.Request.Path,
                context.Response.StatusCode,
                duration.TotalMilliseconds);
        }
    }
}
            
        

        
            9. 数据库配置

            appsettings.json
            
                {
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=StudentManagementDB;Trusted_Connection=true;TrustServerCertificate=true;"
  },
  "Serilog": {
    "MinimumLevel": {
      "Default": "Information",
      "Override": {
        "Microsoft": "Warning",
        "System": "Warning"
      }
    },
    "WriteTo": [
      {
        "Name": "Console"
      },
      {
        "Name": "File",
        "Args": {
          "path": "logs/student-api-.log",
          "rollingInterval": "Day",
          "retainedFileCountLimit": 7
        }
      }
    ]
  },
  "AllowedHosts": "*"
}
            

            appsettings.Development.json
            
                {
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "Microsoft.AspNetCore": "Information"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=StudentManagementDB_Dev;Trusted_Connection=true;TrustServerCertificate=true;"
  }
}
            
        

        
            10. 单元测试

            Tests/StudentServiceTests.cs
            
                using Microsoft.Extensions.Caching.Memory;
using Microsoft.Extensions.Logging;
using Moq;
using SqlSugar;
using StudentAPI.Models.DTOs;
using StudentAPI.Models.Entities;
using StudentAPI.Services.Implementations;
using Xunit;

namespace StudentAPI.Tests
{
    public class StudentServiceTests
    {
        private readonly Mock _mockDb;
        private readonly Mock _mockCache;
        private readonly Mock> _mockLogger;
        private readonly StudentService _studentService;

        public StudentServiceTests()
        {
            _mockDb = new Mock();
            _mockCache = new Mock();
            _mockLogger = new Mock>();
            _studentService = new StudentService(_mockDb.Object, _mockCache.Object, _mockLogger.Object);
        }

        [Fact]
        public async Task AddStudentAsync_ShouldReturnTrue_WhenStudentIsValid()
        {
            // Arrange
            var studentDto = new StudentDto
            {
                StudentNo = "2024001",
                Name = "张三",
                Gender = "男",
                EnrollmentYear = 2024,
                Major = "计算机科学与技术"
            };

            _mockDb.Setup(db => db.Insertable(It.IsAny()))
                   .Returns(Mock.Of>());

            // Act & Assert
            await Assert.ThrowsAsync(() => _studentService.AddStudentAsync(studentDto));
        }

        [Theory]
        [InlineData("", "姓名不能为空")]
        [InlineData("a", "姓名长度不能少于2个字符")]
        public void ValidateStudent_ShouldReturnFalse_WhenNameIsInvalid(string name, string expectedError)
        {
            // Arrange
            var student = new Student
            {
                StudentNo = "2024001",
                Name = name,
                Gender = "男",
                EnrollmentYear = 2024
            };

            // Act
            var result = student.ValidateStudent();

            // Assert
            Assert.False(result.IsValid);
            Assert.Contains(expectedError, result.ErrorMessages);
        }
    }
}
            
        

        
            11. 部署配置

            Dockerfile
            
                # 使用官方的.NET 9 SDK镜像作为构建环境
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /app

# 复制项目文件
COPY *.csproj ./
RUN dotnet restore

# 复制所有源代码
COPY . ./
RUN dotnet publish -c Release -o out

# 使用官方的.NET 9运行时镜像
FROM mcr.microsoft.com/dotnet/aspnet:9.0
WORKDIR /app
COPY --from=build /app/out .

# 暴露端口
EXPOSE 80
EXPOSE 443

# 启动应用
ENTRYPOINT ["dotnet", "StudentAPI.dll"]
            

            docker-compose.yml
            
                version: '3.8'

services:
  student-api:
    build: .
    ports:
      - "5000:80"
      - "5001:443"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80;https://+:443
    depends_on:
      - sqlserver
    networks:
      - student-network

  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      SA_PASSWORD: "YourPassword123!"
      ACCEPT_EULA: "Y"
    ports:
      - "1433:1433"
    volumes:
      - sqlserver-data:/var/opt/mssql
    networks:
      - student-network

volumes:
  sqlserver-data:

networks:
  student-network:
    driver: bridge
            

            11.1 IIS部署
            
                # 发布应用
dotnet publish -c Release -o ./publish

# 配置IIS
# 1. 创建应用程序池，设置.NET CLR版本为"无托管代码"
# 2. 创建网站，指向发布目录
# 3. 确保应用程序池标识具有必要权限

# web.config配置示例


  
    
      
    
    
  

            

            11.2 生产环境配置
            appsettings.Production.json
            
                {
  "Logging": {
    "LogLevel": {
      "Default": "Warning",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=prod-server;Database=StudentManagementDB;User Id=sa;Password=YourProductionPassword;TrustServerCertificate=true;"
  },
  "Serilog": {
    "MinimumLevel": {
      "Default": "Warning"
    },
    "WriteTo": [
      {
        "Name": "File",
        "Args": {
          "path": "/var/log/student-api/student-api-.log",
          "rollingInterval": "Day",
          "retainedFileCountLimit": 30
        }
      }
    ]
  }
}
            
        
    

    
        // 导出功能实现
        function getDocumentContent() {
            const container = document.getElementById('documentContent');
            const clone = container.cloneNode(true);
            const exportButtons = clone.querySelector('.export-buttons');
            if (exportButtons) {
                exportButtons.remove();
            }
            return clone;
        }

        function exportToWord() {
            const btn = document.getElementById('wordBtn');
            btn.disabled = true;
            btn.innerHTML = '⏳ 生成中...';
            
            try {
                const content = getDocumentContent();
                const wordContent = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' 
                          xmlns:w='urn:schemas-microsoft-com:office:word'
                          xmlns='http://www.w3.org/TR/REC-html40'>
                    <head>
                        <meta charset='utf-8'>
                        <title>学生管理系统后端开发文档</title>
                        <style>
                            body { font-family: '微软雅黑', Arial, sans-serif; line-height: 1.6; margin: 40px; }
                            h1 { color: #2c3e50; text-align: center; border-bottom: 3px solid #512bd4; padding-bottom: 20px; }
                            h2 { color: #34495e; border-left: 4px solid #512bd4; padding-left: 15px; margin-top: 30px; }
                            h3 { color: #7f8c8d; margin-top: 25px; }
                            .code-block { background: #f8f9fa; border: 1px solid #e9ecef; padding: 15px; border-radius: 5px; font-family: 'Consolas', monospace; }
                            .file-header { background: #512bd4; color: white; padding: 8px 15px; font-weight: bold; }
                            .alert { padding: 15px; border-radius: 5px; margin: 15px 0; }
                            .alert-info { background-color: #d9edf7; border: 1px solid #bce8f1; color: #31708f; }
                            .directory-tree { font-family: monospace; background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; }
                        </style>
                    </head>
                    <body>${content.innerHTML}</body>
                    </html>
                `;
                
                const blob = new Blob(['\ufeff', wordContent], {
                    type: 'application/msword'
                });
                
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = '学生管理系统后端开发文档.doc';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = '💾 导出为 Word';
                }, 1000);
                
            } catch (error) {
                console.error('导出Word失败:', error);
                alert('导出失败，请重试');
                btn.disabled = false;
                btn.innerHTML = '💾 导出为 Word';
            }
        }

        function exportToPDF() {
            const btn = document.getElementById('pdfBtn');
            btn.disabled = true;
            btn.innerHTML = '⏳ 生成中...';
            
            try {
                const content = getDocumentContent();
                const printWindow = window.open('', '_blank');
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>学生管理系统后端开发文档</title>
                        <style>
                            body { font-family: '微软雅黑', Arial, sans-serif; line-height: 1.6; margin: 20px; color: #333; }
                            h1 { color: #2c3e50; text-align: center; border-bottom: 3px solid #512bd4; padding-bottom: 20px; page-break-before: avoid; }
                            h2 { color: #34495e; border-left: 4px solid #512bd4; padding-left: 15px; margin-top: 30px; page-break-before: avoid; }
                            h3 { color: #7f8c8d; margin-top: 25px; page-break-before: avoid; }
                            .code-block { background: #f8f9fa; border: 1px solid #e9ecef; padding: 15px; border-radius: 5px; font-family: 'Consolas', monospace; font-size: 12px; page-break-inside: avoid; }
                            .file-header { background: #512bd4; color: white; padding: 8px 15px; font-weight: bold; border-radius: 5px 5px 0 0; }
                            .alert { padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 14px; }
                            .alert-info { background-color: #d9edf7; border: 1px solid #bce8f1; color: #31708f; }
                            .directory-tree { font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 11px; }
                            pre { white-space: pre-wrap; word-wrap: break-word; }
                            @media print {
                                body { margin: 0; }
                                .page-break { page-break-before: always; }
                            }
                        </style>
                    </head>
                    <body>
                        ${content.innerHTML}
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                    
                    btn.disabled = false;
                    btn.innerHTML = '📋 导出为 PDF';
                }, 1000);
                
            } catch (error) {
                console.error('导出PDF失败:', error);
                alert('导出失败，请重试');
                btn.disabled = false;
                btn.innerHTML = '📋 导出为 PDF';
            }
        }

        function exportToMarkdown() {
            const btn = document.getElementById('mdBtn');
            btn.disabled = true;
            btn.innerHTML = '⏳ 生成中...';
            
            try {
                const content = getDocumentContent();
                let markdown = '# 学生管理系统后端开发完整文档\n\n';
                
                const sections = content.querySelectorAll('section');
                sections.forEach(section => {
                    const h2 = section.querySelector('h2');
                    if (h2) {
                        markdown += `## ${h2.textContent}\n\n`;
                    }
                    
                    const h3Elements = section.querySelectorAll('h3');
                    h3Elements.forEach(h3 => {
                        markdown += `### ${h3.textContent}\n\n`;
                    });
                    
                    const paragraphs = section.querySelectorAll('p');
                    paragraphs.forEach(p => {
                        if (p.textContent.trim()) {
                            markdown += `${p.textContent.trim()}\n\n`;
                        }
                    });
                    
                    const lists = section.querySelectorAll('ul, ol');
                    lists.forEach(list => {
                        const items = list.querySelectorAll('li');
                        items.forEach(item => {
                            markdown += `- ${item.textContent.trim()}\n`;
                        });
                        markdown += '\n';
                    });
                    
                    const codeBlocks = section.querySelectorAll('.code-block');
                    codeBlocks.forEach(code => {
                        const fileHeader = code.previousElementSibling;
                        if (fileHeader && fileHeader.classList.contains('file-header')) {
                            markdown += `#### ${fileHeader.textContent}\n\n`;
                        }
                        markdown += '```\n';
                        markdown += code.textContent.trim();
                        markdown += '\n```\n\n';
                    });
                    
                    markdown += '\n---\n\n';
                });
                
                const blob = new Blob([markdown], {
                    type: 'text/markdown;charset=utf-8'
                });
                
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = '学生管理系统后端开发文档.md';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = '📝 导出为 Markdown';
                }, 1000);
                
            } catch (error) {
                console.error('导出Markdown失败:', error);
                alert('导出失败，请重试');
                btn.disabled = false;
                btn.innerHTML = '📝 导出为 Markdown';
            }
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('学生管理系统后端开发文档已加载');
            
            // 添加平滑滚动效果
            document.querySelectorAll('.toc a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
        });
```

#### Middleware/LoggingMiddleware.cs

```
namespace StudentAPI.Middleware
{
    public class LoggingMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger _logger;

        public LoggingMiddleware(RequestDelegate next, ILogger logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var startTime = DateTime.UtcNow;
            
            _logger.LogInformation("开始处理请求: {Method} {Path}", 
                context.Request.Method, 
                context.Request.Path);

            await _next(context);

            var duration = DateTime.UtcNow - startTime;
            
            _logger.LogInformation("请求处理完成: {Method} {Path} 响应: {StatusCode} 耗时: {Duration}ms",
                context.Request.Method,
                context.Request.Path,
                context.Response.StatusCode,
                duration.TotalMilliseconds);
        }
    }
}
```

#### appsettings.json

```
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=StudentManagementDB;Trusted_Connection=true;TrustServerCertificate=true;"
  },
  "Serilog": {
    "MinimumLevel": {
      "Default": "Information",
      "Override": {
        "Microsoft": "Warning",
        "System": "Warning"
      }
    },
    "WriteTo": [
      {
        "Name": "Console"
      },
      {
        "Name": "File",
        "Args": {
          "path": "logs/student-api-.log",
          "rollingInterval": "Day",
          "retainedFileCountLimit": 7
        }
      }
    ]
  },
  "AllowedHosts": "*"
}
```

#### appsettings.Development.json

```
{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "Microsoft.AspNetCore": "Information"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=StudentManagementDB_Dev;Trusted_Connection=true;TrustServerCertificate=true;"
  }
}
```

#### Tests/StudentServiceTests.cs

```
using Microsoft.Extensions.Caching.Memory;
using Microsoft.Extensions.Logging;
using Moq;
using SqlSugar;
using StudentAPI.Models.DTOs;
using StudentAPI.Models.Entities;
using StudentAPI.Services.Implementations;
using Xunit;

namespace StudentAPI.Tests
{
    public class StudentServiceTests
    {
        private readonly Mock _mockDb;
        private readonly Mock _mockCache;
        private readonly Mock> _mockLogger;
        private readonly StudentService _studentService;

        public StudentServiceTests()
        {
            _mockDb = new Mock();
            _mockCache = new Mock();
            _mockLogger = new Mock>();
            _studentService = new StudentService(_mockDb.Object, _mockCache.Object, _mockLogger.Object);
        }

        [Fact]
        public async Task AddStudentAsync_ShouldReturnTrue_WhenStudentIsValid()
        {
            // Arrange
            var studentDto = new StudentDto
            {
                StudentNo = "2024001",
                Name = "张三",
                Gender = "男",
                EnrollmentYear = 2024,
                Major = "计算机科学与技术"
            };

            _mockDb.Setup(db => db.Insertable(It.IsAny()))
                   .Returns(Mock.Of>());

            // Act & Assert
            await Assert.ThrowsAsync(() => _studentService.AddStudentAsync(studentDto));
        }

        [Theory]
        [InlineData("", "姓名不能为空")]
        [InlineData("a", "姓名长度不能少于2个字符")]
        public void ValidateStudent_ShouldReturnFalse_WhenNameIsInvalid(string name, string expectedError)
        {
            // Arrange
            var student = new Student
            {
                StudentNo = "2024001",
                Name = name,
                Gender = "男",
                EnrollmentYear = 2024
            };

            // Act
            var result = student.ValidateStudent();

            // Assert
            Assert.False(result.IsValid);
            Assert.Contains(expectedError, result.ErrorMessages);
        }
    }
}
```

#### Dockerfile

```
# 使用官方的.NET 9 SDK镜像作为构建环境
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /app

# 复制项目文件
COPY *.csproj ./
RUN dotnet restore

# 复制所有源代码
COPY . ./
RUN dotnet publish -c Release -o out

# 使用官方的.NET 9运行时镜像
FROM mcr.microsoft.com/dotnet/aspnet:9.0
WORKDIR /app
COPY --from=build /app/out .

# 暴露端口
EXPOSE 80
EXPOSE 443

# 启动应用
ENTRYPOINT ["dotnet", "StudentAPI.dll"]
```

#### docker-compose.yml

```
version: '3.8'

services:
  student-api:
    build: .
    ports:
      - "5000:80"
      - "5001:443"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80;https://+:443
    depends_on:
      - sqlserver
    networks:
      - student-network

  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      SA_PASSWORD: "YourPassword123!"
      ACCEPT_EULA: "Y"
    ports:
      - "1433:1433"
    volumes:
      - sqlserver-data:/var/opt/mssql
    networks:
      - student-network

volumes:
  sqlserver-data:

networks:
  student-network:
    driver: bridge
```

```
# 发布应用
dotnet publish -c Release -o ./publish

# 配置IIS
# 1. 创建应用程序池，设置.NET CLR版本为"无托管代码"
# 2. 创建网站，指向发布目录
# 3. 确保应用程序池标识具有必要权限

# web.config配置示例
```

#### appsettings.Production.json

```
{
  "Logging": {
    "LogLevel": {
      "Default": "Warning",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=prod-server;Database=StudentManagementDB;User Id=sa;Password=YourProductionPassword;TrustServerCertificate=true;"
  },
  "Serilog": {
    "MinimumLevel": {
      "Default": "Warning"
    },
    "WriteTo": [
      {
        "Name": "File",
        "Args": {
          "path": "/var/log/student-api/student-api-.log",
          "rollingInterval": "Day",
          "retainedFileCountLimit": 30
        }
      }
    ]
  }
}
```


---

## 9. 数据库配置

#### appsettings.json

```
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=StudentManagementDB;Trusted_Connection=true;TrustServerCertificate=true;"
  },
  "Serilog": {
    "MinimumLevel": {
      "Default": "Information",
      "Override": {
        "Microsoft": "Warning",
        "System": "Warning"
      }
    },
    "WriteTo": [
      {
        "Name": "Console"
      },
      {
        "Name": "File",
        "Args": {
          "path": "logs/student-api-.log",
          "rollingInterval": "Day",
          "retainedFileCountLimit": 7
        }
      }
    ]
  },
  "AllowedHosts": "*"
}
```

#### appsettings.Development.json

```
{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "Microsoft.AspNetCore": "Information"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=StudentManagementDB_Dev;Trusted_Connection=true;TrustServerCertificate=true;"
  }
}
```


---

## 10. 单元测试

#### Tests/StudentServiceTests.cs

```
using Microsoft.Extensions.Caching.Memory;
using Microsoft.Extensions.Logging;
using Moq;
using SqlSugar;
using StudentAPI.Models.DTOs;
using StudentAPI.Models.Entities;
using StudentAPI.Services.Implementations;
using Xunit;

namespace StudentAPI.Tests
{
    public class StudentServiceTests
    {
        private readonly Mock _mockDb;
        private readonly Mock _mockCache;
        private readonly Mock> _mockLogger;
        private readonly StudentService _studentService;

        public StudentServiceTests()
        {
            _mockDb = new Mock();
            _mockCache = new Mock();
            _mockLogger = new Mock>();
            _studentService = new StudentService(_mockDb.Object, _mockCache.Object, _mockLogger.Object);
        }

        [Fact]
        public async Task AddStudentAsync_ShouldReturnTrue_WhenStudentIsValid()
        {
            // Arrange
            var studentDto = new StudentDto
            {
                StudentNo = "2024001",
                Name = "张三",
                Gender = "男",
                EnrollmentYear = 2024,
                Major = "计算机科学与技术"
            };

            _mockDb.Setup(db => db.Insertable(It.IsAny()))
                   .Returns(Mock.Of>());

            // Act & Assert
            await Assert.ThrowsAsync(() => _studentService.AddStudentAsync(studentDto));
        }

        [Theory]
        [InlineData("", "姓名不能为空")]
        [InlineData("a", "姓名长度不能少于2个字符")]
        public void ValidateStudent_ShouldReturnFalse_WhenNameIsInvalid(string name, string expectedError)
        {
            // Arrange
            var student = new Student
            {
                StudentNo = "2024001",
                Name = name,
                Gender = "男",
                EnrollmentYear = 2024
            };

            // Act
            var result = student.ValidateStudent();

            // Assert
            Assert.False(result.IsValid);
            Assert.Contains(expectedError, result.ErrorMessages);
        }
    }
}
```


---

## 11. 部署配置

### 11.1 IIS部署

### 11.2 生产环境配置

#### Dockerfile

```
# 使用官方的.NET 9 SDK镜像作为构建环境
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /app

# 复制项目文件
COPY *.csproj ./
RUN dotnet restore

# 复制所有源代码
COPY . ./
RUN dotnet publish -c Release -o out

# 使用官方的.NET 9运行时镜像
FROM mcr.microsoft.com/dotnet/aspnet:9.0
WORKDIR /app
COPY --from=build /app/out .

# 暴露端口
EXPOSE 80
EXPOSE 443

# 启动应用
ENTRYPOINT ["dotnet", "StudentAPI.dll"]
```

#### docker-compose.yml

```
version: '3.8'

services:
  student-api:
    build: .
    ports:
      - "5000:80"
      - "5001:443"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80;https://+:443
    depends_on:
      - sqlserver
    networks:
      - student-network

  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      SA_PASSWORD: "YourPassword123!"
      ACCEPT_EULA: "Y"
    ports:
      - "1433:1433"
    volumes:
      - sqlserver-data:/var/opt/mssql
    networks:
      - student-network

volumes:
  sqlserver-data:

networks:
  student-network:
    driver: bridge
```

```
# 发布应用
dotnet publish -c Release -o ./publish

# 配置IIS
# 1. 创建应用程序池，设置.NET CLR版本为"无托管代码"
# 2. 创建网站，指向发布目录
# 3. 确保应用程序池标识具有必要权限

# web.config配置示例
```

#### appsettings.Production.json

```
{
  "Logging": {
    "LogLevel": {
      "Default": "Warning",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=prod-server;Database=StudentManagementDB;User Id=sa;Password=YourProductionPassword;TrustServerCertificate=true;"
  },
  "Serilog": {
    "MinimumLevel": {
      "Default": "Warning"
    },
    "WriteTo": [
      {
        "Name": "File",
        "Args": {
          "path": "/var/log/student-api/student-api-.log",
          "rollingInterval": "Day",
          "retainedFileCountLimit": 30
        }
      }
    ]
  }
}
```


---

